SICP 読書ノート#49 - RubyでSchemeインタプリタをつくろう(8) - 環境に対する操作 (pp.213-228)
======================================

環境および束縛、代入まわりを実装しました。やってみると意外と簡単だった。

```scheme
> (define a 1)
=> nil
> a
=> 1

> (define y 1)
=> nil
> (set! y 2)
=> nil
> y
=> 2

> (set! z 3)
"set_variable_value! : unbound variable z"

> (define foo (lambda (x) "foo"))
=> nil
> (foo 1)
=> "foo"
```

ソースコードはGitHubに置いています。

- https://github.com/uents/sicp/tree/master/ch4-evaluator


### 環境に対する操作

SICPを参考にEnvironmentクラスを実装。変数と値のペアはHashで持たせる。SICPのコードよりはずっとシンプルにできたと思う。

```ruby
class Environment
  def initialize()
    @frames = [{}]
  end

  def lookup_variable_value(var)
    @frames.each do |frame|
      return frame[var] if frame[var] != nil
    end
    raise "lookup_variable_value : unbound variable " + var.to_s
  end

  def extend_environment(vars, values)
    begin
      @frames = [make_frame(vars, values)] + @frames
    rescue
      raise "extend_envronment : fatal error " +
            vars.to_s + " " + values.to_s
    end
  end

  def define_variable!(var, value)
    @frames[0][var] = value
  end

  def set_variable_value!(var, value)
    @frames.each do |frame|
      return frame[var] = value if frame[var] != nil
    end
    raise "set_variable_value! : unbound variable " + var.to_s
  end

  private
  def make_frame(vars, values)
    vars.zip(values).to_h
  end
end
```

### 変数の評価

Variableオブジェクトを評価する際は環境から変数を探す。

```ruby
  class Variable
    attr_reader :name

    def initialize(name)
      @name = name
    end

    def eval(env)
      env.lookup_variable_value(@name)
    end
  end
```

### 束縛と評価

Assignment、Definitionのevalをそれぞれ実装。

```ruby
  class Assignment < Base
    def initialize(operands)
      @variable = Mapper.map(operands[0])
      @value = Mapper.map(operands[1])      
    end

    def eval(env)
      env.set_variable_value!(@variable.name, @value.eval(env))
      nil
    end
  end

  class Definition < Base
    def initialize(operands)
      @variable = Mapper.map(operands[0])
      @value = Mapper.map(operands[1])      
    end

    def eval(env)
      env.define_variable!(@variable.name, @value.eval(env))
      nil
    end
  end
```

処理系の基盤部分は結構できてきたと思う。次はprimitive proceduresあたりかな。

--------------------------------

※「SICP読書ノート」の目次は[こちら](/entry/sicp/index)


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />

