SICP 読書ノート#34 - 3.4 並列性：時が本質的 (pp.xxx-xxx)
======================================

## はじめに

前節までに局所状態を持つオブジェクトを取り入れたけれど、局所状態とは即ち「時」を意識することになる。ここでは異なるタイミングで複数のプロセスから共有オブジェクトの状態を参照したり変更したりする場合に、どういった課題があるかといったことを学んでいく。


## 3.4.1 並列システムでの時

### 問題 3.38

#### (a)

残高(balance)の遷移は次の6パターン。

* パターン1 (★a)
 - ```100 -> (Peter) -> 110 -> (Paul) -> 90 -> (Mary) -> 45```
* パターン2
 - ```100 -> (Peter) -> 110 -> (Mary) -> 55 -> (Paul) -> 35```
* パターン3 (★a)
 - ```100 -> (Paul) -> 80 -> (Peter) -> 90 -> (Mary) -> 45```
* パターン4
 - ```100 -> (Paul) -> 80 -> (Mary) -> 40 -> (Peter) -> 50```
* パターン5 (★b)
 - ```100 -> (Mary) -> 50 -> (Peter) -> 60 -> (Paul) -> 40```
* パターン6 (★b)
 - ```100 -> (Mary) -> 50 -> (Paul) -> 30 -> (Peter) -> 40```

★a,bのようにPaulとPeterが続く場合は最終の残高が同じになる。これはPaulとPeterは残高に対して単純に差し引きしているため。

一方でMaryは前の残高を半分に減らす、つまり前の状態に依存して次の状態が決まるため、どこに来るかで最終の状態が変わってくる。

#### (b)

(a)当初の残高100に対してPaul、Peter、Maryの3者が同時に、または2者だけが同時にアクセスする場合のパターンが起こり得る。

すなわち最終残高が(a)の６パターンの遷移の途中の値でとどまってしまうことが想定されるので、起こり得る値としては110、80、50、90、55、40、60、30、45、35、45の11通り。


## 3.4.2

前節の「2つ以上のプロセスが全く同時にアクセス」といったことを避けるために、処理の直列化(シリアライズ)を検討する。

### 問題 3.39

例で示されている並列処理を分解すると、

* プロセスP1
 - (1) 引数1のxをread
 - (2) 引数2のxをread
 - (3) それらを乗算
 - (4) 結果をxへ代入

* プロセスP2
 - (a) 引数1のxをread
 - (b) それに1を加算
 - (c) 結果をxへ代入

となる。これらが並列で実行されるパターンは、

* パターンA
 - ```(1)->(2)->(3)->(4)->(a)->(b)->(c)：x=101```
* パターンB
 - ```(a)->(b)->(c)->(1)->(2)->(3)->(4)：x=121```
* パターンC：
 - ```(1)->(a)->(b)->(c)->(2)->(3)->(4)：x=110```
* パターンD：
 - ```(a)->(1)->(2)->(3)->(4)->(b)->(c)：x=11```
* パターンE：
 - ```(1)->(2)->(3)->(a)->(b)->(c)->(4)：x=100```


となる。シリアライザを適用したコードを見ると

```scheme
(define x 10)
(define s (make-serializer))
(parallel-execute (s (lambda () (set! x (* x x))))
                  (s (lambda () (set! x (* x x x)))))

```

上記の処理```(1)->(2)->(3)```および```(a)->(b)->(c)```が直列化されるので、起こり得るパターンは上記のA、B、Eとなる。


### 問題 3.40

問題3.39と同じ要領で考える。

* プロセスP1
  - (1) 引数1のxをread
  - (2) 引数2のxをread
  - (3) これらを乗算
  - (4) 結果をxへ代入

* プロセスP2
  - (v) 引数1のxをread
  - (w) 引数2のxをread
  - (x) 引数3のxをread
  - (y) これらを乗算
  - (z) 結果をxへ代入

手続きがシリアライズされた場合は、

* パターンA
 - ```(1)->(2)->(3)->(4)->(v)->(w)->(x)->(y)->(z)：10^6```
* パターンB
 - ```(v)->(w)->(x)->(y)->(z)->(1)->(2)->(3)->(4)：10^9```

の2通りが起こり得る。


### 問題 3.41

### 問題 3.42

### 問題 3.43

### 問題 3.44

### 問題 3.45

### 問題 3.46

### 問題 3.47

### 問題 3.48

### 問題 3.49



次は「§3.5 ストリーム」から。

--------------------------------

※「SICP読書ノート」の目次は[こちら](/entry/sicp/index)
